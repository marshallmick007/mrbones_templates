var gulp = require('gulp');
var concat = require('gulp-concat');
var sourcemaps = require('gulp-sourcemaps');
var uglify = require('gulp-uglify');
var ngAnnotate = require('gulp-ng-annotate');
var less = require('gulp-less');
var path = require('path');
var del = require('del');
var paths = {
  vendor: "bower_components",
}
gulp.task('js', function () {
    gulp.src([
             'public/app/**/module.js',
             'public/app/**/controllers/*.js',
             'public/app/**/services/*.js' ,
             'public/app/app.js',
             'public/app/**/*.js'])
        .pipe(sourcemaps.init())
            .pipe(concat('public/dist/js/app.js'))
            .pipe(ngAnnotate())
            .pipe(uglify({ mangle: true }))
        .pipe(sourcemaps.write())
        .pipe(gulp.dest('.'))
    ;
});

//gulp.task('clean-bootstrap', function(cb) {
//  // You can use multiple globbing patterns as you would with `gulp.src`
//  del(['./public/stylesheets/theme.css'], cb);
//});

gulp.task('bootstrap', function () {
  // See available less optons here: https://github.com/less/less.js/blob/master/bin/lessc#L10
  gulp.src(['./less/*.less'])
    .pipe(less({
        paths: [ path.join( paths.vendor, 'bootstrap', 'less' )],
        compress: false
      }))
    .pipe(gulp.dest('./public/dist/css'));
});
gulp.task('jsbootstrap', function(){
    // Add any bootstrap javascripts the app needs here.
    // This will get included in the 'jslib' build task
    gulp.src([ path.join( paths.vendor, 'bootstrap/js/dropdown.js')])
      .pipe(concat( path.join( paths.vendor, 'bootstrap/dist/js/bootstrap-custom.js')))
      .pipe(gulp.dest('.'))
    ;
});
gulp.task('jslib', ['jsbootstrap'], function() {
    gulp.src([
        'bower_components/jquery/dist/jquery.min.js',
        'bower_components/angularjs/angular.min.js',
        'bower_components/angular-animate/angular-animate.min.js',
        'bower_components/angular-ui-router/release/angular-ui-router.min.js',
        'bower_components/lodash/dist/lodash.min.js',
        'bower_components/moment/min/moment.min.js',
        'bower_components/bootstrap/dist/js/bootstrap-custom.js'
        ])
        .pipe(concat('public/dist/js/vendor.js'))
        .pipe(gulp.dest('.'))
    ;
});

gulp.task('default', ['js', 'jslib', 'bootstrap'], function () {
    gulp.watch('public/app/**/*.js', ['js']);
    gulp.watch('less/**/*.less', ['bootstrap']);
});

